name: train-model

on:
  pull_request:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      experiment_name:  {type: str, required: true}
      learning_rate:    {type: str, required: true}
      max_depth:        {type: str, required: true}
      n_estimators:     {type: str, required: true}

defaults:
  run:
    shell: bash

env:
  experiment_name:  ${{ inputs.experiment_name }}
  learning_rate:    ${{ inputs.learning_rate || '0.1' }}
  max_depth:        ${{ inputs.max_depth || '10' }}
  n_estimators:     ${{ inputs.n_estimators || '5' }}
  

jobs:
  test:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - name: Install Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.9
          cache: pip
      
      - name: Install model dependencies
        run: pip install -r model/requirements.txt

      - name: Train model with different parameters
        env:
          MLFLOW_TRACKING_URI: ${{ secrets.MLFLOW_TRACKING_URI }}
          MLFLOW_TRACKING_USERNAME: ${{ secrets.MLFLOW_TRACKING_USERNAME }}
          MLFLOW_TRACKING_PASSWORD: ${{ secrets.MLFLOW_TRACKING_PASSWORD }}
          # silence mlflow deprecation warnings as DagsHub's MLflow
          # doesn't support 'mlflow.search_experiments()' call:
          PYTHONWARNINGS: ignore
        run: |
          python model/train.py \
            --experiment_name=${experiment_name} \
            --run_name="lr-${learning_rate}-md-${max_depth}-ne-${n_estimators}" \
            --learning_rate=${learning_rate} \
            --max_depth=${max_depth} \
            --n_estimators=${n_estimators}
